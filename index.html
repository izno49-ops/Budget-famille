<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="manifest" href="manifest.json">
    <title>Budget Sync</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .tab-active { border-bottom: 3px solid #4f46e5; color: #4f46e5; background: white; }
        #auth-screen { position: fixed; inset: 0; background: #f1f5f9; z-index: 10000; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body class="bg-[#f8fafc]">

    <div id="auth-screen">
        <div class="p-8 bg-white rounded-[2.5rem] shadow-2xl text-center max-w-sm w-full mx-4">
            <h2 class="text-2xl font-black mb-6">Budget Famille</h2>
            <div class="space-y-3 mb-6">
                <input type="email" id="login-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 focus:border-indigo-500">
                <input type="password" id="login-password" placeholder="Mot de passe" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 focus:border-indigo-500">
            </div>
            <button onclick="validerConnexion()" id="btn-auth" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black">
                SE CONNECTER
            </button>
        </div>
    </div>

    <div id="app-content" style="display:none;" class="p-4 max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8 bg-white p-4 rounded-3xl shadow-sm">
            <span id="user-display" class="font-black text-indigo-600 uppercase text-sm">Chargement...</span>
            <button onclick="firebase.auth().signOut()" class="text-xs font-bold text-rose-500">DÃ‰CONNEXION</button>
        </header>

        <div class="grid grid-cols-1 gap-4 mb-8">
            <div class="bg-white p-6 rounded-3xl shadow-sm text-center">
                <p class="text-xs font-bold text-slate-400 uppercase">Solde Total</p>
                <h3 id="solde-total" class="text-3xl font-black">0.00 â‚¬</h3>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl overflow-hidden mb-8">
            <div class="flex p-2 bg-slate-50 gap-2">
                <button onclick="changerType('expense')" id="tab-exp" class="flex-1 py-3 rounded-xl font-black text-xs tab-active">SORTIE</button>
                <button onclick="changerType('income')" id="tab-inc" class="flex-1 py-3 rounded-xl font-black text-xs text-slate-400">ENTRÃ‰E</button>
            </div>
            <div class="p-6 space-y-4">
                <input type="text" id="ope-desc" placeholder="Objet" class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
                <input type="number" id="ope-amt" placeholder="Montant" class="w-full p-4 bg-slate-50 rounded-2xl outline-none text-xl font-black">
                <button onclick="ajouterOperation()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">ENREGISTRER</button>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
            <table class="w-full text-left">
                <tbody id="liste-ope" class="divide-y"></tbody>
            </table>
        </div>
    </div>

    <script>
        // 1. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyDxBlFg_z1gWM-O9lHH0UdqLmqRyno7Eys",
            databaseURL: "https://budget-20988-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "budget-20988",
        };
        firebase.initializeApp(firebaseConfig);

        const PROFIL_NOMS = {
            "izno49@gmail.com": "ClÃ©ment ðŸ§”",
            "maman@famille.com": "Maman ðŸ‘©"
        };

        let currentType = 'expense';
        let dataLocal = [];

        // 2. FONCTION DE CONNEXION
        function validerConnexion() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            const btn = document.getElementById('btn-auth');

            if(!email || !pass) return alert("Remplissez les champs");

            btn.disabled = true;
            btn.innerText = "VERIFICATION...";

            firebase.auth().signInWithEmailAndPassword(email, pass)
                .catch(err => {
                    alert("Erreur: " + err.message);
                    btn.disabled = false;
                    btn.innerText = "SE CONNECTER";
                });
        }

        // 3. SURVEILLANCE AUTH
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('user-display').innerText = PROFIL_NOMS[user.email] || user.email;
                ecouterDonnees();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-content').style.display = 'none';
            }
        });

        // 4. DONNÃ‰ES
        function ecouterDonnees() {
            firebase.database().ref('data/transactions').on('value', snap => {
                dataLocal = snap.val() || [];
                rafraichirInterface();
            });
        }

        function changerType(t) {
            currentType = t;
            document.getElementById('tab-exp').className = t === 'expense' ? 'flex-1 py-3 rounded-xl font-black text-xs tab-active' : 'flex-1 py-3 rounded-xl font-black text-xs text-slate-400';
            document.getElementById('tab-inc').className = t === 'income' ? 'flex-1 py-3 rounded-xl font-black text-xs tab-active' : 'flex-1 py-3 rounded-xl font-black text-xs text-slate-400';
        }

        function ajouterOperation() {
            const desc = document.getElementById('ope-desc').value;
            const amt = parseFloat(document.getElementById('ope-amt').value);
            const user = firebase.auth().currentUser;

            if(!desc || isNaN(amt)) return alert("Incomplet");

            const nouvelleOpe = {
                id: Date.now(),
                txt: desc,
                val: currentType === 'expense' ? -Math.abs(amt) : Math.abs(amt),
                user: PROFIL_NOMS[user.email] || user.email,
                date: new Date().toLocaleDateString('fr-FR')
            };

            dataLocal.unshift(nouvelleOpe);
            firebase.database().ref('data/transactions').set(dataLocal).then(() => {
                document.getElementById('ope-desc').value = "";
                document.getElementById('ope-amt').value = "";
            });
        }

        function rafraichirInterface() {
            const liste = document.getElementById('liste-ope');
            let total = 0;
            liste.innerHTML = "";
            
            dataLocal.forEach(t => {
                total += t.val;
                liste.innerHTML += `
                    <tr class="p-4 flex justify-between items-center">
                        <td class="p-4">
                            <div class="font-black text-slate-800">${t.txt}</div>
                            <div class="text-[10px] text-slate-400 font-bold uppercase">${t.user} â€¢ ${t.date}</div>
                        </td>
                        <td class="p-4 font-black ${t.val < 0 ? 'text-rose-500' : 'text-emerald-500'}">
                            ${t.val.toLocaleString()} â‚¬
                        </td>
                    </tr>`;
            });
            document.getElementById('solde-total').innerText = total.toLocaleString() + " â‚¬";
        }
    </script>
</body>
</html>
