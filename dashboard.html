<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arce Finance | v15.7 Full Power</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        :root { --primary: #6366f1; --primary-dark: #4f46e5; --bg: #f8fafc; --glass: rgba(255, 255, 255, 0.9); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); color: #1e293b; height: 100vh; overflow: hidden; }
        .glass-card { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); border-radius: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); transition: all 0.3s ease; }
        .glass-card:hover { transform: translateY(-2px); box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.1); }
        .u-input { background: rgba(241, 245, 249, 0.8); border: 1px solid #e2e8f0; border-radius: 1rem; padding: 0.875rem 1.25rem; transition: all 0.2s; color: #1e293b; font-size: 0.875rem; outline: none; }
        .u-input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15); }
        .btn-main { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; font-weight: 800; border-radius: 1rem; padding: 0.875rem 1.75rem; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem; cursor: pointer; border:none; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); filter: brightness(1.1); }
        .sidebar { background: #0f172a; color: white; }
        .sidebar-link { display: flex; align-items: center; gap: 0.875rem; padding: 1rem; border-radius: 1rem; color: #94a3b8; font-size: 0.875rem; font-weight: 700; transition: all 0.2s; border:none; background:transparent; cursor:pointer; width: 100%; }
        .sidebar-link:hover, .sidebar-link.active { background: rgba(255,255,255,0.1); color: white; }
        .blur-private { transition: filter 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .privacy-enabled .blur-private { filter: blur(15px); }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        #toast { visibility: hidden; min-width: 300px; background: #1e293b; color: #fff; text-align: center; border-radius: 1.25rem; padding: 1.25rem; position: fixed; z-index: 10000; left: 50%; bottom: 40px; transform: translateX(-50%); font-weight: 700; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        #toast.show { visibility: visible; animation: slideUp 0.5s forwards; }
        @keyframes slideUp { from { bottom: 0; opacity: 0; } to { bottom: 40px; opacity: 1; } }
    </style>
</head>
<body class="flex overflow-hidden">

    <div id="toast">Message</div>

    <div id="auth-screen" class="fixed inset-0 z-[9999] flex items-center justify-center bg-[#0f172a]">
        <div class="bg-white p-12 rounded-[3rem] w-full max-w-md shadow-2xl text-center">
            <div class="w-20 h-20 bg-indigo-600 rounded-[2rem] mx-auto mb-8 flex items-center justify-center shadow-2xl shadow-indigo-500/20">
                <span class="text-white text-4xl font-black">A</span>
            </div>
            <h2 class="text-3xl font-black text-slate-900 mb-2">Arce Finance</h2>
            <p class="text-slate-400 text-sm mb-10 font-medium">Acc√®s Patrimonial S√©curis√©</p>
            <div class="space-y-4">
                <input type="email" id="loginEmail" placeholder="Identifiant" class="u-input w-full">
                <input type="password" id="loginPassword" placeholder="Cl√© Ma√Ætresse" class="u-input w-full">
                <button onclick="login()" class="btn-main w-full py-5 text-sm mt-4">Initialiser Session</button>
            </div>
        </div>
    </div>

    <aside class="w-80 sidebar flex flex-col p-8 h-full z-50 shadow-2xl">
        <div class="flex items-center gap-4 mb-12 px-2">
            <div class="w-10 h-10 bg-indigo-500 rounded-xl flex items-center justify-center font-black text-white">A</div>
            <div>
                <h1 class="font-black text-xl tracking-tight leading-none">Arce Finance</h1>
                <span class="text-[10px] font-bold text-indigo-400 tracking-[0.2em] uppercase">Private Suite</span>
            </div>
        </div>
        <nav class="flex-1 space-y-2">
            <button onclick="location.reload()" class="sidebar-link active"><span>üìä</span> Dashboard Global</button>
            <button onclick="openModal('projectModal')" class="sidebar-link"><span>üèóÔ∏è</span> Gestion Projets</button>
            <button onclick="openModal('creditModal')" class="sidebar-link"><span>üí≥</span> Lignes de Cr√©dit</button>
            <button onclick="openModal('savingModal')" class="sidebar-link"><span>üéØ</span> Actifs & √âpargne</button>
            <div class="pt-6 mt-6 border-t border-slate-800">
                <button onclick="openModal('maintenanceModal')" class="sidebar-link text-amber-400 hover:text-amber-300"><span>üõ†Ô∏è</span> Maintenance</button>
            </div>
        </nav>
        <div class="mt-auto space-y-4">
            <button onclick="togglePrivacy()" class="w-full py-4 px-5 rounded-2xl border border-slate-700 text-[11px] font-extrabold uppercase hover:bg-slate-800 transition flex items-center justify-between">
                <span>Dissimulation</span>
                <span id="privacyStatus" class="bg-indigo-500/20 text-indigo-400 px-3 py-1 rounded-lg">OFF</span>
            </button>
            <div class="bg-slate-800/50 p-5 rounded-2xl">
                <p id="user-tag" class="text-[10px] text-slate-400 font-bold truncate uppercase tracking-widest mb-3">...</p>
                <button onclick="logout()" class="text-rose-400 text-xs font-black uppercase hover:text-rose-300 transition">D√©connexion</button>
            </div>
        </div>
    </aside>

    <main id="app-content" class="flex-1 overflow-y-auto p-12 opacity-0 transition-opacity duration-1000 custom-scroll">
        <div class="flex justify-between items-end mb-12">
            <div>
                <h2 class="text-4xl font-black text-slate-900 tracking-tighter">Tableau de <span class="text-indigo-600">Bord</span></h2>
                <p class="text-slate-500 font-semibold mt-1">Analyse v15.7 Full Power | Multi-Channel AI</p>
            </div>
            <div class="flex gap-6">
                <div class="glass-card px-10 py-6 flex flex-col items-end border-b-4 border-slate-300">
                    <span class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest">Patrimoine Net</span>
                    <span id="totalBalance" class="text-3xl font-black text-slate-900 blur-private">0.00 ‚Ç¨</span>
                </div>
                <div class="glass-card px-10 py-6 flex flex-col items-end border-b-4 border-indigo-500">
                    <span class="text-[11px] font-extrabold text-indigo-500 uppercase tracking-widest">Reste √† vivre</span>
                    <span id="leftToSpend" class="text-3xl font-black text-indigo-600 blur-private">0.00 ‚Ç¨</span>
                </div>
            </div>
        </div>

        <div id="topCardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-10"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 mb-10">
            <div class="glass-card p-10 lg:col-span-2">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="font-black text-sm uppercase tracking-widest text-slate-400">Flux de Tr√©sorerie</h3>
                    <div id="ai-status-tag" class="text-[11px] font-bold text-indigo-600 bg-indigo-50 px-4 py-1.5 rounded-full border border-indigo-100">IA MULTI-CANAL ACTIVE</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <input type="text" id="manualDesc" placeholder="D√©signation du flux" class="u-input md:col-span-2">
                    <input type="number" id="manualAmount" placeholder="Montant ‚Ç¨" class="u-input font-bold text-indigo-600">
                    <label class="flex items-center justify-center gap-3 bg-slate-50 rounded-2xl border border-slate-200 cursor-pointer hover:bg-white transition">
                        <input type="checkbox" id="manualIsRec" class="w-4 h-4 accent-indigo-600">
                        <span class="text-[10px] font-bold uppercase text-slate-500">Fixe</span>
                    </label>
                </div>
                <div class="flex gap-4">
                    <input type="text" id="ai-query" placeholder="Demander une analyse experte..." class="flex-1 u-input italic">
                    <button onclick="askAI()" class="px-8 bg-slate-900 text-white rounded-2xl text-[10px] font-bold uppercase hover:bg-black transition">Analyste IA</button>
                    <button onclick="saveManualTx()" class="btn-main px-10">Valider</button>
                </div>
            </div>
            <div class="glass-card p-8 flex flex-col">
                <h3 class="font-black text-[11px] uppercase tracking-widest text-slate-400 mb-6">Charges Fixes Mensuelles</h3>
                <div class="flex-1 overflow-y-auto custom-scroll pr-4" style="max-height: 200px;">
                    <table class="w-full"><tbody id="recurrentList" class="text-[12px] font-bold text-slate-600 divide-y divide-slate-100"></tbody></table>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 mb-10">
            <div class="glass-card p-10 lg:col-span-2"><div style="height: 350px;"><canvas id="evolutionChart"></canvas></div></div>
            <div class="glass-card p-10"><div style="height: 350px;"><canvas id="pieChart"></canvas></div></div>
        </div>

        <div class="glass-card overflow-hidden">
            <div class="p-8 bg-slate-50/50 border-b flex justify-between items-center">
                <h3 class="font-black text-lg text-slate-800">Registre Analytique</h3>
                <div class="flex gap-4">
                    <select id="dateFilter" onchange="triggerRender()" class="u-input text-[11px] font-bold uppercase py-2">
                        <option value="all">Historique Complet</option>
                        <option value="month">Mois en cours</option>
                    </select>
                </div>
            </div>
            <table class="w-full text-left">
                <thead class="bg-slate-50/80 text-[10px] font-black uppercase text-slate-400">
                    <tr><th class="px-10 py-5">Date</th><th class="px-10 py-5">D√©signation</th><th class="px-10 py-5 text-right">Valeur</th><th class="px-10 py-5">Type</th><th class="px-10 py-5 text-right">Action</th></tr>
                </thead>
                <tbody id="txTable" class="divide-y divide-slate-100 text-sm font-semibold"></tbody>
            </table>
        </div>
    </main>

    <div id="maintenanceModal" class="fixed inset-0 z-[9900] flex items-center justify-center bg-slate-900/90 hidden backdrop-blur-sm">
        <div class="bg-white p-12 rounded-[3rem] w-full max-w-lg shadow-2xl">
            <h3 class="font-black text-2xl mb-10 text-center uppercase tracking-tighter">Administration</h3>
            <div class="space-y-4">
                <button onclick="downloadBackupOnly()" class="w-full p-6 bg-slate-50 rounded-2xl flex justify-between items-center hover:bg-indigo-50 border border-transparent hover:border-indigo-200 transition">
                    <span class="text-sm font-black">Exporter Sauvegarde</span>
                    <span class="text-[10px] bg-indigo-600 text-white px-3 py-1 rounded font-bold uppercase">Export</span>
                </button>
                <button onclick="document.getElementById('importFile').click()" class="w-full p-6 bg-slate-50 rounded-2xl flex justify-between items-center hover:bg-emerald-50 border border-transparent hover:border-emerald-200 transition">
                    <span class="text-sm font-black">Importer Donn√©es</span>
                    <span class="text-[10px] bg-emerald-600 text-white px-3 py-1 rounded font-bold uppercase">Import</span>
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="handleImport(event)">
                </button>
            </div>
            <button onclick="closeModal('maintenanceModal')" class="w-full mt-10 text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Fermer</button>
        </div>
    </div>

    <div id="projectModal" class="fixed inset-0 z-[9000] flex items-center justify-center bg-slate-900/80 hidden">
        <div class="bg-white p-10 rounded-[2.5rem] w-full max-w-sm">
            <h3 class="font-black text-xl mb-8 uppercase text-indigo-600">üèóÔ∏è Nouveau Projet</h3>
            <input type="text" id="projName" placeholder="Nom du projet" class="u-input w-full mb-4">
            <input type="number" id="projBudget" placeholder="Budget cible ‚Ç¨" class="u-input w-full mb-6">
            <button onclick="handleSaveProject()" class="btn-main w-full py-4">Cr√©er l'Objectif</button>
            <button onclick="closeModal('projectModal')" class="w-full mt-4 text-[10px] font-black uppercase text-slate-400 text-center">Annuler</button>
        </div>
    </div>

    <div id="creditModal" class="fixed inset-0 z-[9000] flex items-center justify-center bg-slate-900/80 hidden">
        <div class="bg-white p-10 rounded-[2.5rem] w-full max-w-sm">
            <h3 class="font-black text-xl mb-8 uppercase text-rose-600">üí≥ Nouveau Cr√©dit</h3>
            <input type="text" id="creLibelle" placeholder="Nom (Ex: Immo)" class="u-input w-full mb-3">
            <input type="number" id="creTotal" placeholder="Capital emprunt√© ‚Ç¨" class="u-input w-full mb-3">
            <input type="number" id="creMonthly" placeholder="Mensualit√© ‚Ç¨" class="u-input w-full mb-6">
            <button onclick="handleSaveCredit()" class="btn-main w-full bg-rose-600 shadow-rose-200">Activer le Pr√™t</button>
            <button onclick="closeModal('creditModal')" class="w-full mt-4 text-[10px] font-black uppercase text-slate-400 text-center">Annuler</button>
        </div>
    </div>

    <div id="savingModal" class="fixed inset-0 z-[9000] flex items-center justify-center bg-slate-900/80 hidden">
        <div class="bg-white p-10 rounded-[2.5rem] w-full max-w-sm">
            <h3 class="font-black text-xl mb-8 uppercase text-emerald-600">üéØ Actifs / √âpargne</h3>
            <input type="text" id="saveNomCompte" placeholder="Nom du compte" class="u-input w-full mb-4">
            <input type="number" id="saveCurrent" placeholder="Solde actuel ‚Ç¨" class="u-input w-full mb-6">
            <button onclick="handleSaveSaving()" class="btn-main w-full bg-emerald-600 shadow-emerald-200">Mettre √† jour</button>
            <button onclick="closeModal('savingModal')" class="w-full mt-4 text-[10px] font-black uppercase text-slate-400 text-center">Annuler</button>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDxBlFg_z1gWM-O9lHH0UdqLmqRyno7Eys", authDomain: "budget-20988.firebaseapp.com", databaseURL: "https://budget-20988-default-rtdb.europe-west1.firebasedatabase.app/", projectId: "budget-20988" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(), auth = firebase.auth();
        const GEMINI_KEY = "AIzaSyAbDdBSfFDeL3C7-FhNKF6mexukF2g3sY8";

        let globalData = {};
        let chartLine = null, chartPie = null, currentUserEmail = "";

        // UI LOGIC
        window.showToast = (msg) => { const t = document.getElementById("toast"); t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); };
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.togglePrivacy = () => { document.body.classList.toggle('privacy-enabled'); document.getElementById('privacyStatus').innerText = document.body.classList.contains('privacy-enabled') ? "ON" : "OFF"; };
        window.login = () => { const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPassword').value; auth.signInWithEmailAndPassword(e, p).catch(() => showToast("Acc√®s Refus√©")); };
        window.logout = () => auth.signOut().then(() => location.reload());

        // TRANSACTION LOGIC
        window.saveManualTx = () => {
            const amt = parseFloat(document.getElementById('manualAmount').value);
            const desc = document.getElementById('manualDesc').value;
            if(!desc || isNaN(amt)) return showToast("Saisie Incompl√®te");
            db.ref(`data/transactions/${Date.now()}`).set({ id: Date.now(), date: new Date().toLocaleDateString('fr-FR'), iso: new Date().toISOString(), description: desc, amount: amt, category: amt < 0 ? 'D√âBIT' : 'CR√âDIT', isRecurring: document.getElementById('manualIsRec').checked, author: currentUserEmail });
            document.getElementById('manualAmount').value = ''; document.getElementById('manualDesc').value = '';
        };

        window.handleSaveProject = () => { const n = document.getElementById('projName').value, b = parseFloat(document.getElementById('projBudget').value); if(n && b) db.ref(`data/projects/${Date.now()}`).set({id: Date.now(), name: n, budget: b}).then(()=>closeModal('projectModal')); };
        window.handleSaveCredit = () => { const l = document.getElementById('creLibelle').value, t = parseFloat(document.getElementById('creTotal').value), m = parseFloat(document.getElementById('creMonthly').value); if(l && t) db.ref(`data/credits/${Date.now()}`).set({id: Date.now(), name: l, total: t, monthly: m}).then(()=>closeModal('creditModal')); };
        window.handleSaveSaving = () => { const n = document.getElementById('saveNomCompte').value, c = parseFloat(document.getElementById('saveCurrent').value); if(n && !isNaN(c)) db.ref(`data/savings/${Date.now()}`).set({id: Date.now(), name: n, current: c}).then(()=>closeModal('savingModal')); };
        window.deleteItem = (path, id) => { if(confirm("Supprimer l'enregistrement ?")) db.ref(`data/${path}/${id}`).remove(); };
        window.triggerRender = () => renderUI(globalData);

        // DATA MAINTENANCE
        window.downloadBackupOnly = () => {
            const blob = new Blob([JSON.stringify(globalData)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `arce_finance_v15_7.json`; a.click();
        };
        window.handleImport = (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    const clean = imported.data ? imported.data : imported;
                    if (confirm("Restaurer les donn√©es ?")) { await db.ref('data').set(clean); location.reload(); }
                } catch (err) { showToast("Format JSON invalide"); }
            };
            reader.readAsText(file);
        };

        // --- EXPERT IA v15.7 (MULTI-CHANNEL FAILOVER SYSTEM) ---
        window.askAI = async () => {
            const status = document.getElementById('ai-status-tag');
            const query = document.getElementById('ai-query').value;
            if(!query) return showToast("Question vide");

            status.innerText = "RECHERCHE CANAL OPTIMAL...";
            status.className = "text-[11px] font-bold text-amber-600 bg-amber-50 px-4 py-1.5 rounded-full animate-pulse";

            const payload = {
                contents: [{ parts: [{ text: `Tu es l'analyste priv√© Arce Finance. Fortune: ${document.getElementById('totalBalance').innerText}, Reste: ${document.getElementById('leftToSpend').innerText}. R√©ponds court et pro : ${query}` }] }]
            };

            // Liste ordonn√©e des tentatives (Version API + Nom Mod√®le)
            const endpoints = [
                { v: 'v1beta', m: 'gemini-1.5-flash' },
                { v: 'v1', m: 'gemini-1.5-flash' },
                { v: 'v1beta', m: 'gemini-1.5-pro' },
                { v: 'v1', m: 'gemini-1.5-pro' }
            ];

            let success = false;

            for (let channel of endpoints) {
                if(success) break;
                try {
                    console.log(`Tentative sur Canal: ${channel.m} (${channel.v})...`);
                    const response = await fetch(`https://generativelanguage.googleapis.com/${channel.v}/models/${channel.m}:generateContent?key=${GEMINI_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        alert("ANALYSE EXPERTE ARCE :\n\n" + result.candidates[0].content.parts[0].text);
                        success = true;
                        status.innerText = "IA ANALYSTE ACTIVE";
                        status.className = "text-[11px] font-bold text-indigo-600 bg-indigo-50 px-4 py-1.5 rounded-full border border-indigo-100";
                    } else {
                        console.warn(`Canal ${channel.m} rejet√©: `, result);
                    }
                } catch (err) {
                    console.error(`Erreur Canal ${channel.m}: `, err);
                }
            }

            if (!success) {
                showToast("√âchec de connexion aux serveurs Google (404/Quota)");
                status.innerText = "IA INDISPONIBLE";
                status.className = "text-[11px] font-bold text-rose-600 bg-rose-50 px-4 py-1.5 rounded-full border border-rose-100";
            }
        };

        // ENGINE
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserEmail = user.email;
                document.getElementById('user-tag').innerText = `SESSION : ${user.email.toUpperCase()}`;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('opacity-0');
                db.ref('data').on('value', snap => { globalData = snap.val() || {}; renderUI(globalData); });
            }
        });

        function renderUI(data) {
            const txs = Object.values(data.transactions || {}).sort((a,b) => new Date(b.iso) - new Date(a.iso));
            const credits = Object.values(data.credits || {});
            
            credits.forEach(c => {
                c.autoPaid = txs.filter(t => t.description.toLowerCase().includes(c.name.toLowerCase()) && t.amount < 0)
                                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            });

            const grid = document.getElementById('topCardsGrid'); grid.innerHTML = '';
            Object.values(data.projects || {}).forEach(p => grid.innerHTML += cardUI(p.name, p.budget, 'indigo', 'Cible Projet'));
            credits.forEach(c => grid.innerHTML += cardUI(c.name, (c.total - c.autoPaid), 'rose', `Dette (-${c.monthly}‚Ç¨)`));
            Object.values(data.savings || {}).forEach(s => grid.innerHTML += cardUI(s.name, s.current, 'emerald', 'Actif Bancaire'));

            const filter = document.getElementById('dateFilter').value;
            let total = 0, fixes = 0, stats = {};
            const table = document.getElementById('txTable'); table.innerHTML = '';
            const recList = document.getElementById('recurrentList'); recList.innerHTML = '';

            txs.forEach(t => {
                const tDate = new Date(t.iso);
                let pass = (filter === 'all') || (filter === 'month' && tDate.getMonth() === new Date().getMonth());
                
                if(pass) {
                    total += t.amount;
                    if(t.isRecurring && t.amount < 0) {
                        fixes += Math.abs(t.amount);
                        recList.innerHTML += `<tr class="h-10"><td>${t.description}</td><td class="text-right text-rose-500 font-black">-${Math.abs(t.amount).toFixed(2)}‚Ç¨</td></tr>`;
                    }
                    if(t.amount < 0) stats[t.category || 'DIVERS'] = (stats[t.category || 'DIVERS'] || 0) + Math.abs(t.amount);
                    
                    table.innerHTML += `<tr class="hover:bg-slate-50 transition">
                        <td class="px-10 py-4 text-slate-400 font-bold">${t.date}</td>
                        <td class="px-10 py-4 font-black text-slate-800">${t.description}</td>
                        <td class="px-10 py-4 text-right font-black ${t.amount < 0 ? 'text-rose-500' : 'text-emerald-500'}">${t.amount.toLocaleString()} ‚Ç¨</td>
                        <td class="px-10 py-4 uppercase text-[10px] font-black text-slate-400">${t.isRecurring ? 'Fid√®le' : 'Unique'}</td>
                        <td class="px-10 py-4 text-right"><button onclick="deleteItem('transactions', '${t.id}')">üóëÔ∏è</button></td>
                    </tr>`;
                }
            });

            document.getElementById('totalBalance').innerText = total.toLocaleString('fr-FR', { minimumFractionDigits: 2 }) + " ‚Ç¨";
            document.getElementById('leftToSpend').innerText = (total - fixes).toLocaleString('fr-FR', { minimumFractionDigits: 2 }) + " ‚Ç¨";
            updateCharts(stats, [...txs].reverse().reduce((acc, t) => { acc.push((acc[acc.length-1] || 0) + t.amount); return acc; }, []));
        }

        function cardUI(n, v, c, t) {
            return `<div class="glass-card p-6 border-l-4 border-${c}-500">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">${t}</p>
                <p class="font-black text-slate-800 truncate mb-2 text-lg">${n}</p>
                <p class="text-xl font-black text-${c}-600 blur-private">${v.toLocaleString()} ‚Ç¨</p>
            </div>`;
        }

        function updateCharts(stats, history) {
            const ctx1 = document.getElementById('evolutionChart').getContext('2d');
            if(chartLine) chartLine.destroy();
            chartLine = new Chart(ctx1, { type: 'line', data: { labels: history.map((_,i)=>i), datasets: [{ data: history, borderColor: '#6366f1', borderWidth: 4, tension: 0.4, fill: true, backgroundColor: 'rgba(99, 102, 241, 0.05)', pointRadius: 0 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: 'rgba(0,0,0,0.03)' } } } } });
            const ctx2 = document.getElementById('pieChart').getContext('2d');
            if(chartPie) chartPie.destroy();
            chartPie = new Chart(ctx2, { type: 'doughnut', data: { labels: Object.keys(stats), datasets: [{ data: Object.values(stats), backgroundColor: ['#6366f1', '#f43f5e', '#10b981', '#fbbf24', '#8b5cf6'], borderWeight: 0 }] }, options: { maintainAspectRatio: false, cutout: '82%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10, weight: '800' } } } } } });
        }
    </script>
</body>
</html>
